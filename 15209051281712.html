<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  fabric自动化部署 - Time渐行渐远
  
  </title>
  
  
  <link href="atom.xml" rel="alternate" title="Time渐行渐远" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
  function before_search(){
    var searchVal = 'site:dmlcoding.com ' + document.getElementById('search_input').value;
    document.getElementById('search_q').value = searchVal;
    return true;
  }
</script>
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        
        <li id=""><a target="_self" href="index.html">Home</a></li>
        
        <li id=""><a target="_self" href="archives.html">Archives</a></li>
        
        <li id=""><a target="_self" href="collections.html">COLLECTION</a></li>
        
        <li id=""><a target="_self" href="tools.html">TOOLS</a></li>
        
        <li id=""><a target="_blank" href="about.html">ABOUT</a></li>
        
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" onsubmit="return before_search();" action="http://google.com/search" method="get">
    <input type="hidden" id="search_q" name="q" value="" />
    <input tabindex="1" type="search" id="search_input"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; Time渐行渐远</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
       
       <li><a href="index.html">HOME</a></li>
    <li><a href="archives.html">Archives</a></li>
    <li><a href="about.html">ABOUT</a></li>

    <li><label>Categories</label></li>

        
            <li><a href="BigData.html">BigData</a></li>
        
            <li><a href="Python.html">Python</a></li>
        
            <li><a href="Linux.html">Linux</a></li>
        
            <li><a href="Life.html">Life</a></li>
        
            <li><a href="Spark.html">Spark</a></li>
        
            <li><a href="Hive.html">Hive</a></li>
        
            <li><a href="Yarn.html">Yarn</a></li>
        
            <li><a href="Scala.html">Scala</a></li>
        
            <li><a href="VPS.html">VPS</a></li>
        
            <li><a href="MachineLearning.html">MachineLearning</a></li>
        
            <li><a href="Writer.html">Writer</a></li>
        
            <li><a href="Shell.html">Shell</a></li>
        
            <li><a href="Algorithm.html">Algorithm</a></li>
        
            <li><a href="Mac.html">Mac</a></li>
        
            <li><a href="Presto.html">Presto</a></li>
        
            <li><a href="Mysql.html">Mysql</a></li>
        
            <li><a href="Maven.html">Maven</a></li>
        
            <li><a href="Kafka.html">Kafka</a></li>
        
            <li><a href="Java.html">Java</a></li>
        
            <li><a href="DevTools.html">DevTools</a></li>
        
            <li><a href="Hbase.html">Hbase</a></li>
        
            <li><a href="ELK.html">ELK</a></li>
        
            <li><a href="Druid.html">Druid</a></li>
        
            <li><a href="Docker.html">Docker</a></li>
        
            <li><a href="DesignPattern.html">DesignPattern</a></li>
        
            <li><a href="Computer.html">Computer</a></li>
        
            <li><a href="Redis.html">Redis</a></li>
        
            <li><a href="Zookeeper.html">Zookeeper</a></li>
        
            <li><a href="BlockChain.html">BlockChain</a></li>
         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
        
       

 <script type="text/javascript">
  $(function(){
    $('#menu_item_index').addClass('is_active');
  });
</script>
<div class="row">
  <div class="large-8 medium-8 columns">
      <div class="markdown-body article-wrap">
       <div class="article">
          
          <h1>fabric自动化部署</h1>
     
        <div class="read-more clearfix">
          <span class="date">2018/3/13</span>

          <span>posted in&nbsp;</span> 
          
              <span class="posted-in"><a href='Python.html'>Python</a></span>
           
         
          <span class="comments">
            

            
          </span>

        </div>
      </div><!-- article -->

      <div class="article-content">
      <h2 id="toc_0">简介</h2>

<p>Fabric是一个用Python开发的部署工具，最大特点是不用登录远程服务器，在本地运行远程命令，几行Python脚本就可以轻松部署。</p>

<p>Fabric提供几个简单的API来完成所有的部署，最常用的是local()和run()，分别在本地和远程执行命令，put()可以把本地文件上传到远程，当需要在远程指定当前目录时，只需用with cd(&#39;/path/to/dir/&#39;):即可。</p>

<p>默认情况下，当命令执行失败时，Fabric会停止执行后续命令。有时，我们允许忽略失败的命令继续执行，比如run(&#39;rm /tmp/abc&#39;)在文件不存在的时候有可能失败，这时可以用with settings(warn_only=True):执行命令，这样Fabric只会打出警告信息而不会中断执行。</p>

<span id="more"></span><!-- more -->

<h2 id="toc_1">Fabric是如何在远程执行命令的呢</h2>

<p>其实Fabric所有操作都是基于SSH执行的，必要时它会提示输入口令，所以非常安全。更好的办法是在指定的部署服务器上用证书配置无密码的ssh连接。</p>

<p>如果是基于团队开发，可以让Fabric利用版本库自动检出代码，自动执行测试、打包、部署的任务。由于Fabric运行的命令都是基本的Linux命令，所以根本不需要用Fabric本身来扩展，会敲Linux命令就能用Fabric部署。</p>

<h1 id="toc_2">安装</h1>

<p>在windows上安装可能会有各种依赖的问题,安装就可能没有那么顺利.</p>

<p>为了减少麻烦.我们直接把你电脑上的原装python都给卸载了吧,无论你是python2还是python3.都卸载了.</p>

<p>我们直接在windows上安装Anaconda包.Anaconda是给机器学习学习者集成的python环境,可以给不想折腾的同学,节省很多安装的时间.</p>

<h2 id="toc_3">下载安装Anaconda</h2>

<p><a href="https://www.anaconda.com/download/#windows">官网下载安装包</a><br/>
<img src="media/15209051281712/15260197981453.jpg" alt=""/></p>

<p>下载python3.6吧,毕竟python2在以后python社区会逐渐的不再维护支持了.另外Anaconda中的python3,可以用虚拟环境创建python2.7的虚拟环境.</p>

<p>下载如图所示后,会有安装包,点击下一步之类的就安装好了,记得在安装的过程中要点上配置环境变量.如果你错过了,那么就只能在安装完成后,自己手动的配置Anaconda的环境变量了.</p>

<p>手动配置Anaconda环境变量参考网上文章,和一般的环境变量没啥区别.</p>

<h2 id="toc_4">创建python2.7的虚拟环境</h2>

<p>因为<code>fabric.py</code>脚本是在python2.7下写的.因此咱们需要创建一个python2.7的环境,然后在这个环境里面下载安装<code>fabric模块</code></p>

<ol>
<li>创建python2.7虚拟环境</li>
</ol>

<pre><code>conda create -n python27 python=2.7
</code></pre>

<ol>
<li>激活python2.7的虚拟环境</li>
</ol>

<pre><code>activate python27
</code></pre>

<ol>
<li>在python2.7环境下安装fabric模块</li>
</ol>

<pre><code>pip install fabric
</code></pre>

<p>到此已经把fabric模块安装完成了.接下来就是使用了.</p>

<ol>
<li>退出python2.7的虚拟环境</li>
</ol>

<pre><code>deactivate
</code></pre>

<h1 id="toc_5">使用</h1>

<ul>
<li><a href="http://www.fabfile.org/installing.html">官网说明</a></li>
</ul>

<h2 id="toc_6">fabric常用api</h2>

<table>
<thead>
<tr>
<th>函数</th>
<th>解释</th>
<th>例子</th>
</tr>
</thead>

<tbody>
<tr>
<td>local</td>
<td>执行本地命令</td>
<td>local(&#39;ls -l&#39;)</td>
</tr>
<tr>
<td>lcd</td>
<td>切换本地目录(需要with包裹)</td>
<td>lcd(&#39;本地目录&#39;)</td>
</tr>
<tr>
<td>run</td>
<td>执行远程命令</td>
<td>run(&#39;ls -l&#39;)</td>
</tr>
<tr>
<td>cd</td>
<td>切换远程目录(需要with包裹)</td>
<td>cd(&#39;远程目录&#39;)</td>
</tr>
<tr>
<td>put</td>
<td>将本地文件上传至远程目录</td>
<td>put(&#39;本地文件&#39;,&#39;远程目录&#39;)</td>
</tr>
<tr>
<td>env</td>
<td>fabric环境，配置远程ip、端口、密码</td>
<td>见下文</td>
</tr>
</tbody>
</table>

<h2 id="toc_7">fabric远程执行例子</h2>

<p>想好你的上线步骤,比如我平时的上线步骤就是这么几步.</p>

<ol>
<li>拉取SVN代码</li>
<li>本地编译打包</li>
<li>上传到服务器</li>
<li>备份服务器上的上一个版本</li>
<li>部署到服务器指定目录</li>
<li>清理多余文件</li>
<li>相关Jar包和文件上传到HDFS</li>
</ol>

<p>如果不符合你的业务需求,可以参考脚本做相应的修改.</p>

<h3 id="toc_8">Mac下的脚本</h3>

<pre><code># -*- coding: utf-8 -*-
&quot;&quot;&quot;
Created by hushiwei on 2017/10/16
desc : 自动化部署上线
1. 更新代码到指定分支
2. 执行 fab deploy
3. OK...
&quot;&quot;&quot;
import os
import datetime
from fabric.api import *
from fabric.contrib.console import confirm
from fabric.colors import blue, red, green
from fabric.contrib.files import *
import sys

local_dir = &quot;/Users/hushiwei/demo/auto_deploy/&quot;
remote_project = &quot;/home/hadoop/statistics/ad/&quot;
remote_dir = &quot;/home/hadoop/statistics/auto_deploy/&quot;
remote_dir_bak = &quot;/home/hadoop/statistics/auto_deploy_bak/&quot;
svn_path = &quot;svn://svn.gm825.com/code/server/bigdata/xxxxxxxxxxx&quot;
hdfs_path = &quot;/user/oozie/ad/&quot;

env.user = &quot;xxxxxxx&quot;

env.hosts = [&#39;***.***.***.***&#39;]
env.password = &#39;**********&#39;


def today():
  return datetime.date.today().strftime(&quot;%Y%m%d&quot;)


def svn_to_local(project_name):
  &#39;&#39;&#39;
  fab svn_to_local:project_name=quickapp
  把项目SVN的trunk代码checkout到本地
  :param project_name:
  :return:
  &#39;&#39;&#39;
  print green(&#39;Checking out the project, SVN Path Is : %s&#39; % svn_path)
  if not os.path.exists(local_dir):
    local(&#39;mkdir &#39; + local_dir)

  with lcd(local_dir):
    local(&#39;rm -rf &#39; + local_dir + project_name)
    local(&#39;svn co &#39; + svn_path, capture=True)
    local(&#39;mv {svn_name} {project_name} &#39;.format(svn_name=svn_path.split(&quot;/&quot;)[-1],project_name=project_name))
  print green(&#39;Checkout The Project --- Finished!&#39;)


def pack_project(project_name):
  &#39;&#39;&#39;
  fab pack_project:project_name=quickapp
  把本地项目打成tar包,准备上传到服务器
  :param project_name:
  :return:
  &#39;&#39;&#39;
  with lcd(local_dir + project_name):
    local(&quot;find &quot; + local_dir + project_name + &quot; -name &#39;.svn&#39; | xargs rm -rf&quot;)
    print(green(&quot;Removed the .svn file --- Finished, Pack the project&quot;))
    local(&#39;mvn clean scala:compile compile package -DskipTests&#39;, capture=True)
    local(&#39;mv oozie %s&#39; % project_name)
    local(&#39;mv target/*-jar-with-dependencies.jar {project_name}/&#39;.format(project_name=project_name))
    local(&#39;mv target/*-SNAPSHOT.jar {project_name}/{project_name}_streaming&#39;.format(project_name=project_name))
    local(&#39;tar cfz {local_dir}{project_name}.tar.gz {project_name}/*&#39;.format(
        project_name=project_name, local_dir=local_dir))

  print green(&#39;Pack the Project --- Finished!&#39;)


def backup_serverfile(project_name):
  &#39;&#39;&#39;
  备份服务器上的项目
  :param project_name:
  :return:
  &#39;&#39;&#39;
  print green(&quot;Back the project on server&quot;)
  with cd(remote_project):
    with settings(warn_only=True):
      # 创建备份文件目录
      if not exists(remote_dir_bak):
        run(&quot;mkdir &quot;+remote_dir_bak)
      run(
          &quot;tar cfz &quot; + remote_dir_bak + project_name + &quot;_&quot; + today() + &quot;.tar.gz --exclude source_log &quot; + project_name + &quot;/&quot;)
      run(&quot;cp -r &quot; + project_name + &quot; &quot; + project_name + &quot;_&quot; + today())
  print green(&quot;Back up the project on server --- Finished!&quot;)


def put_package(project_name):
  &#39;&#39;&#39;
  上传发布包到远程服务器
  :param project_name:
  :return:
  &#39;&#39;&#39;
  if not exists(remote_dir):
    run(&quot;mkdir &quot;+remote_dir)
  print green(&quot;Start upload the Project to the Server ...&quot;)
  with cd(remote_dir):
    with settings(warn_only=True):
      result = put(local_dir + project_name + &quot;.tar.gz&quot;,
                   remote_dir + project_name + &quot;.tar.gz&quot;)
      if result.failed and not confirm(&quot;put file failed,Continue?&quot;):
        abort(&quot;Aborting file put task!&quot;)
  print green(&quot;Put the package to remote server --- Finished!&quot;)


def deploy_project(project_name):
  &#39;&#39;&#39;
  解压线上tar包,进行部署项目
  :param project_name:
  :return:
  &#39;&#39;&#39;
  with cd(remote_dir):
    with settings(warn_only=True):
      result = run(&quot;tar zxf &quot; + project_name + &quot;.tar.gz -C &quot; + remote_project)
    if result.failed:
      print red(&quot;Deploy the Project Failed,Roll backing&quot;)
      roll_back(project_name)
  run(&quot;cd {remote_project} &amp;&amp; chown -R hadoop:hadoop {project_name}&quot;.format(
      remote_project=remote_project, project_name=project_name))
  print(green(&quot;Deploy the package at the server --- Finished&quot;))


def clear_deploy(project_name):
  &#39;&#39;&#39;
  删除部署后留下的多余文件
  :param project_name:
  :return:
  &#39;&#39;&#39;
  with cd(remote_project):
    run(&#39;rm -rf &#39; + project_name + &quot;_&quot; + today())
  with cd(remote_dir):
    run(&quot;rm -rf &quot; + project_name + &quot;.tar.gz&quot;)
  print green(&quot;Clear the files at the server --- Finished&quot;)


def roll_back(project_name):
  &#39;&#39;&#39;
  当部署失败后,回滚到前一个备份版本
  :param project_name:
  :return:
  &#39;&#39;&#39;
  run(&quot;rm -rf &quot; + project_name)
  run(&quot;mv &quot; + project_name + &quot;_&quot; + today() + &quot; &quot; + project_name)
  print red(&quot;Roll back deploy --- Finished&quot;)


@runs_once
@task
def prepare_deploy(project_name=&quot;quickapp&quot;):
  &quot;&quot;&quot;
  部署前准备，下载最新版代码，打包代码
  &quot;&quot;&quot;
  svn_to_local(project_name)
  pack_project(project_name)


def upload_files(project_name):
  hdfs_work=hdfs_path+project_name+&quot;/&quot;
  with cd(remote_project + project_name):
    run(&quot;hadoop fs -put -f ./{wf,hourwf,offlinewf,targetingwf} %s&quot; % hdfs_work)
  print green(&quot;upload files to hdfs --- Finished&quot;)


def upload_jars(project_name):
  hdfs_work=hdfs_path+project_name+&quot;/&quot;
  wfPaths = [&#39;wf&#39;, &#39;hourwf&#39;,&#39;offlinewf&#39;,&#39;targetingwf&#39;]
  with cd(remote_project + project_name):
    for i in range(len(wfPaths)):
      run(&quot;hadoop fs -put -f ./*.jar &quot; + hdfs_work + wfPaths[i] + &quot;/lib&quot;)
  print green(&quot;upload jars to hdfs --- Finished&quot;)


@task
def upload_hdfs(project_name=&quot;quickapp&quot;):
  &#39;&#39;&#39;
  将项目上传到hdfs
  :return:
  &#39;&#39;&#39;
  upload_files(project_name)
  upload_jars(project_name)

@task
def upload_hdfs_by_exec_shell(project_name=&quot;quickapp&quot;):
  &#39;&#39;&#39;
  通过调用项目里面的upgrade.sh脚本来上传项目到hdfs
  :param project_name:
  :return:
  &#39;&#39;&#39;
  with cd(remote_project):
    run(&quot;cd %s/wf/shell &amp;&amp; sh upgrade.sh &quot; % project_name)


@task
def deploy(project_name=&quot;quickapp&quot;, prepated=True):
  &#39;&#39;&#39;
  本地打包,部署到线上服务器,上传到HDFS全流程
  :param project_name:
  :param prepated:
  :return:
  &#39;&#39;&#39;
  if prepated == True:
    prepare_deploy(project_name)
  # 上传
  put_package(project_name)
  # 备份
  backup_serverfile(project_name)
  # 部署
  deploy_project(project_name)
  # 清理
  clear_deploy(project_name)
  # 上传hdfs
  upload_hdfs(project_name)

</code></pre>

<h3 id="toc_9">Windows下的脚本</h3>

<pre><code># -*- coding: utf-8 -*-
&quot;&quot;&quot;
Created by hushiwei on 2017/10/16
desc : 自动化部署上线
1. 更新代码到trunk.
2. 执行 fab deploy
3. OK...
&quot;&quot;&quot;
import os
import datetime
from fabric.api import *
from fabric.contrib.console import confirm
from fabric.colors import blue, red, green
from fabric.contrib.files import *
import os,tarfile


local_dir = &quot;D:\wanka\svn_project\dsp_interact\\&quot;
remote_project = &quot;/home/hadoop/statistics/ad/&quot;
remote_dir = &quot;/home/hadoop/statistics/auto_deploy/&quot;
remote_dir_bak = &quot;/home/hadoop/statistics/auto_deploy_bak/&quot;
svn_path = &quot;svn://svn.gm825.com/code/server/bigdata/xxxxxxxxxx&quot;
hdfs_path = &quot;/user/oozie/ad/&quot;

env.user = &quot;xxxxxxx&quot;

env.hosts = [&#39;***.***.***.***&#39;]
env.password = &#39;**********&#39;

# python在windows环境打tar包.output_filename为tar包文件,source_dir为要打包的目录
def make_targz(output_filename, source_dir):
  with tarfile.open(output_filename, &quot;w:gz&quot;) as tar:
    tar.add(source_dir, arcname=os.path.basename(source_dir))

def today():
  return datetime.date.today().strftime(&quot;%Y%m%d&quot;)


def svn_to_local(project_name):
  &#39;&#39;&#39;
  fab svn_to_local:project_name=dsp_interaction_ad
  把项目SVN的trunk代码checkout到本地
  :param project_name:
  :return:
  &#39;&#39;&#39;
  print green(&#39;Checking out the project, SVN Path Is : %s&#39; % svn_path)
  if not os.path.exists(local_dir):
    local(&#39;mkdir &#39; + local_dir)

  with lcd(local_dir):

    # local(&#39;rm -rf &#39; + local_dir + project_name)

    local(&#39;if exist &#39; + local_dir + project_name + &#39; (rd /s /q &#39; + local_dir + project_name + &#39;)&#39;)
    local(&#39;if exist &#39; + local_dir + project_name + &#39;.tar.gz (del &#39; + local_dir + project_name + &#39;.tar.gz)&#39;)

    local(&#39;svn co &#39; + svn_path, capture=True)
    local(&#39;rename {svn_name} {project_name} &#39;.format(svn_name=svn_path.split(&quot;/&quot;)[-1],project_name=project_name))
  print green(&#39;Checkout The Project --- Finished!&#39;)


def pack_project(project_name):
  &#39;&#39;&#39;
  fab pack_project:project_name=dsp_interaction_ad
  把本地项目打成tar包,准备上传到服务器
  :param project_name:
  :return:
  &#39;&#39;&#39;
  # with lcd(local_dir + project_name):
  with lcd(local_dir):
    
    local(&quot;rd /s /q &quot; + local_dir + project_name + &#39;\\.svn&#39;, capture=True)
    print(green(&quot;Removed the .svn file --- Finished, Pack the project&quot;))

  with lcd(local_dir + project_name):
    local(&#39;mvn clean scala:compile compile package -DskipTests&#39;, capture=True)
    local(&#39;rename oozie %s&#39; % project_name)
    local(&#39;move target\\*-jar-with-dependencies.jar {project_name}\\&#39;.format(project_name=project_name))
    local(&#39;move target\\*-SNAPSHOT.jar {project_name}\\{project_name}_streaming&#39;.format(project_name=project_name))

    make_targz(local_dir + project_name + &#39;.tar.gz&#39;, local_dir + project_name + &#39;\\&#39; + project_name)

  print green(&#39;Pack the Project --- Finished!&#39;)


def backup_serverfile(project_name):
  &#39;&#39;&#39;
  备份服务器上的项目
  :param project_name:
  :return:
  &#39;&#39;&#39;
  print green(&quot;Back the project on server&quot;)
  with cd(remote_project):
    with settings(warn_only=True):
      # 创建备份文件目录
      if not exists(remote_dir_bak):
        run(&quot;mkdir &quot;+remote_dir_bak)
      run(
          &quot;tar cfz &quot; + remote_dir_bak + project_name + &quot;_&quot; + today() + &quot;.tar.gz --exclude source_log &quot; + project_name + &quot;/&quot;)
      run(&quot;cp -r &quot; + project_name + &quot; &quot; + project_name + &quot;_&quot; + today())
  print green(&quot;Back up the project on server --- Finished!&quot;)


def put_package(project_name):
  &#39;&#39;&#39;
  上传发布包到远程服务器
  :param project_name:
  :return:
  &#39;&#39;&#39;
  if not exists(remote_dir):
    run(&quot;mkdir &quot;+remote_dir)
  print green(&quot;Start upload the Project to the Server ...&quot;)
  with cd(remote_dir):
    with settings(warn_only=True):
      result = put(local_dir + project_name + &quot;.tar.gz&quot;,
                   remote_dir + project_name + &quot;.tar.gz&quot;)
      if result.failed and not confirm(&quot;put file failed,Continue?&quot;):
        abort(&quot;Aborting file put task!&quot;)
  print green(&quot;Put the package to remote server --- Finished!&quot;)


def deploy_project(project_name):
  &#39;&#39;&#39;
  解压线上tar包,进行部署项目
  :param project_name:
  :return:
  &#39;&#39;&#39;
  with cd(remote_dir):
    with settings(warn_only=True):
      result = run(&quot;tar zxf &quot; + project_name + &quot;.tar.gz -C &quot; + remote_project)
    if result.failed:
      print red(&quot;Deploy the Project Failed,Roll backing&quot;)
      roll_back(project_name)
  run(&quot;cd {remote_project} &amp;&amp; chown -R hadoop:hadoop {project_name}&quot;.format(
      remote_project=remote_project, project_name=project_name))
  print(green(&quot;Deploy the package at the server --- Finished&quot;))


def clear_deploy(project_name):
  &#39;&#39;&#39;
  删除部署后留下的多余文件
  :param project_name:
  :return:
  &#39;&#39;&#39;
  with cd(remote_project):
    run(&#39;rm -rf &#39; + project_name + &quot;_&quot; + today())
  with cd(remote_dir):
    run(&quot;rm -rf &quot; + project_name + &quot;.tar.gz&quot;)
  print green(&quot;Clear the files at the server --- Finished&quot;)


def roll_back(project_name):
  &#39;&#39;&#39;
  当部署失败后,回滚到前一个备份版本
  :param project_name:
  :return:
  &#39;&#39;&#39;
  run(&quot;rm -rf &quot; + project_name)
  run(&quot;mv &quot; + project_name + &quot;_&quot; + today() + &quot; &quot; + project_name)
  print red(&quot;Roll back deploy --- Finished&quot;)


@runs_once
@task
def prepare_deploy(project_name=&quot;dsp_interaction_ad&quot;):
  &quot;&quot;&quot;
  部署前准备，下载最新版代码，打包代码
  &quot;&quot;&quot;
  svn_to_local(project_name)
  pack_project(project_name)


def upload_files(project_name):
  hdfs_work=hdfs_path+project_name+&quot;/&quot;
  with cd(remote_project + project_name):
    run(&quot;hadoop fs -put -f ./{wf,hourwf,offlinewf,targetingwf} %s&quot; % hdfs_work)
  print green(&quot;upload files to hdfs --- Finished&quot;)


def upload_jars(project_name):
  hdfs_work=hdfs_path+project_name+&quot;/&quot;
  wfPaths = [&#39;wf&#39;, &#39;hourwf&#39;,&#39;offlinewf&#39;,&#39;targetingwf&#39;]
  with cd(remote_project + project_name):
    for i in range(len(wfPaths)):
      run(&quot;hadoop fs -put -f ./*.jar &quot; + hdfs_work + wfPaths[i] + &quot;/lib&quot;)
  print green(&quot;upload jars to hdfs --- Finished&quot;)


@task
def upload_hdfs(project_name=&quot;dsp_interaction_ad&quot;):
  &#39;&#39;&#39;
  将项目上传到hdfs
  :return:
  &#39;&#39;&#39;
  upload_files(project_name)
  upload_jars(project_name)

@task
def upload_hdfs_by_exec_shell(project_name=&quot;dsp_interaction_ad&quot;):
  &#39;&#39;&#39;
  通过调用项目里面的upgrade.sh脚本来上传项目到hdfs
  :param project_name:
  :return:
  &#39;&#39;&#39;
  with cd(remote_project):
    run(&quot;cd %s/wf/shell &amp;&amp; sh upgrade.sh &quot; % project_name)


@task
def deploy(project_name=&quot;dsp_interaction_ad&quot;, prepated=True):
  &#39;&#39;&#39;
  本地打包,部署到线上服务器,上传到HDFS全流程
  :param project_name:
  :param prepated:
  :return:
  &#39;&#39;&#39;
  if prepated == True:
    prepare_deploy(project_name)
  # 上传
  put_package(project_name)
  # 备份
  backup_serverfile(project_name)
  # 部署
  deploy_project(project_name)
  # 清理
  clear_deploy(project_name)
  # 上传hdfs
  upload_hdfs(project_name)

</code></pre>

<h2 id="toc_10">执行命令</h2>

<p>在执行fab命令之前,需要先激活之前安装的python2.7虚拟环境.在这个环境下才可以执行fab命令</p>

<pre><code>activate python27
</code></pre>

<p>激活python2.7环境后,我们就在fabric.py文件的同级目录下执行<strong>fab deploy</strong>即可一键上线</p>

<pre><code>fab deploy
</code></pre>

<p>至于其他更加详细的命令,可以执行<strong>fab -h</strong>参考官方说明.</p>

<pre><code> hushiwei@hsw  ~  fab -h
Usage: fab [options] &lt;command&gt;[:arg1,arg2=val2,host=foo,hosts=&#39;h1;h2&#39;,...] ...

Options:
  -h, --help            show this help message and exit
  -d NAME, --display=NAME
                        print detailed info about command NAME
  -F FORMAT, --list-format=FORMAT
                        formats --list, choices: short, normal, nested
  -I, --initial-password-prompt
                        Force password prompt up-front
  --initial-sudo-password-prompt
                        Force sudo password prompt up-front
  -l, --list            print list of possible commands and exit
  --set=KEY=VALUE,...   comma separated KEY=VALUE pairs to set Fab env vars
  --shortlist           alias for -F short --list
  -V, --version         show program&#39;s version number and exit
  -a, --no_agent        don&#39;t use the running SSH agent
  -A, --forward-agent   forward local agent to remote end
  --abort-on-prompts    abort instead of prompting (for password, host, etc)
  -c PATH, --config=PATH
                        specify location of config file to use
  --colorize-errors     Color error output
  -D, --disable-known-hosts
                        do not load user known_hosts file
  -e, --eagerly-disconnect
                        disconnect from hosts as soon as possible
  -f PATH, --fabfile=PATH
                        python module file to import, e.g. &#39;../other.py&#39;
  -g HOST, --gateway=HOST
                        gateway host to connect through
  --gss-auth            Use GSS-API authentication
  --gss-deleg           Delegate GSS-API client credentials or not
  --gss-kex             Perform GSS-API Key Exchange and user authentication
  --hide=LEVELS         comma-separated list of output levels to hide
  -H HOSTS, --hosts=HOSTS
                        comma-separated list of hosts to operate on
  -i PATH               path to SSH private key file. May be repeated.
  -k, --no-keys         don&#39;t load private key files from ~/.ssh/
  --keepalive=N         enables a keepalive every N seconds
  --linewise            print line-by-line instead of byte-by-byte
  -n M, --connection-attempts=M
                        make M attempts to connect before giving up
  --no-pty              do not use pseudo-terminal in run/sudo
  -p PASSWORD, --password=PASSWORD
                        password for use with authentication and/or sudo
  -P, --parallel        default to parallel execution method
  --port=PORT           SSH connection port
  -r, --reject-unknown-hosts
                        reject unknown hosts
  --sudo-password=SUDO_PASSWORD
                        password for use with sudo only
  --system-known-hosts=SYSTEM_KNOWN_HOSTS
                        load system known_hosts file before reading user
                        known_hosts
  -R ROLES, --roles=ROLES
                        comma-separated list of roles to operate on
  -s SHELL, --shell=SHELL
                        specify a new shell, defaults to &#39;/bin/bash -l -c&#39;
  --show=LEVELS         comma-separated list of output levels to show
  --skip-bad-hosts      skip over hosts that can&#39;t be reached
  --skip-unknown-tasks  skip over unknown tasks
  --ssh-config-path=PATH
                        Path to SSH config file
  -t N, --timeout=N     set connection timeout to N seconds
  -T N, --command-timeout=N
                        set remote command timeout to N seconds
  -u USER, --user=USER  username to use when connecting to remote hosts
  -w, --warn-only       warn, instead of abort, when commands fail
  -x HOSTS, --exclude-hosts=HOSTS
                        comma-separated list of hosts to exclude
  -z INT, --pool-size=INT
                        number of concurrent processes to use in parallel mode
</code></pre>


    

      </div>

      <div class="row">
        <div class="large-6 columns">
        <p class="text-left" style="padding:15px 0px;">
      
          <a href="15209079363420.html" 
          title="Previous Post: 大数据框架-开源协议">&laquo; 大数据框架-开源协议</a>
      
        </p>
        </div>
        <div class="large-6 columns">
      <p class="text-right" style="padding:15px 0px;">
      
          <a  href="15205689785115.html" 
          title="Next Post: Zookeeper笔记">Zookeeper笔记 &raquo;</a>
      
      </p>
        </div>
      </div>
      <div class="comments-wrap">
        <div class="share-comments">
          

          

          
        </div>
      </div>
    </div><!-- article-wrap -->
  </div><!-- large 8 -->




 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <div class="site-a-logo"><img src="https://s.gravatar.com/avatar/2d9bdeec5ad2754d8a47063df1346ee8?s=80" /></div>
            
                <h1>Time渐行渐远</h1>
                <div class="site-des">Coding Changing The World</div>
                <div class="social">







<a target="_blank" class="weibo" href="http://weibo.com/hswnice" title="weibo">Weibo</a>
<a target="_blank" class="twitter" target="_blank" href="https://twitter.com/HswTime" title="Twitter">Twitter</a>
<a target="_blank" class="github" target="_blank" href="https://github.com/Timehsw" title="GitHub">GitHub</a>
<a target="_blank" class="email" href="mailto:hsw_v5@163.com" title="Email">Email</a>
  <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
        
            <a href="BigData.html"><strong>BigData</strong></a>
        
            <a href="Python.html"><strong>Python</strong></a>
        
            <a href="Linux.html"><strong>Linux</strong></a>
        
            <a href="Life.html"><strong>Life</strong></a>
        
            <a href="Spark.html"><strong>Spark</strong></a>
        
            <a href="Hive.html"><strong>Hive</strong></a>
        
            <a href="Yarn.html"><strong>Yarn</strong></a>
        
            <a href="Scala.html"><strong>Scala</strong></a>
        
            <a href="VPS.html"><strong>VPS</strong></a>
        
            <a href="MachineLearning.html"><strong>MachineLearning</strong></a>
        
            <a href="Writer.html"><strong>Writer</strong></a>
        
            <a href="Shell.html"><strong>Shell</strong></a>
        
            <a href="Algorithm.html"><strong>Algorithm</strong></a>
        
            <a href="Mac.html"><strong>Mac</strong></a>
        
            <a href="Presto.html"><strong>Presto</strong></a>
        
            <a href="Mysql.html"><strong>Mysql</strong></a>
        
            <a href="Maven.html"><strong>Maven</strong></a>
        
            <a href="Kafka.html"><strong>Kafka</strong></a>
        
            <a href="Java.html"><strong>Java</strong></a>
        
            <a href="DevTools.html"><strong>DevTools</strong></a>
        
            <a href="Hbase.html"><strong>Hbase</strong></a>
        
            <a href="ELK.html"><strong>ELK</strong></a>
        
            <a href="Druid.html"><strong>Druid</strong></a>
        
            <a href="Docker.html"><strong>Docker</strong></a>
        
            <a href="DesignPattern.html"><strong>DesignPattern</strong></a>
        
            <a href="Computer.html"><strong>Computer</strong></a>
        
            <a href="Redis.html"><strong>Redis</strong></a>
        
            <a href="Zookeeper.html"><strong>Zookeeper</strong></a>
        
            <a href="BlockChain.html"><strong>BlockChain</strong></a>
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="15255701784620.html">集成学习</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15255685118456.html">决策树</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15198753668603.html">逻辑回归</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15248143200628.html">回归算法</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15263722402424.html">学习机器学习</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
</div>

        </section>
      </div>
    </div>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>

    <script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?2a025c7742b90ad62b1e767e1b7f2f29";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </body>
</html>
